version: '3.8'

services:
  # 1. DDNS-Client: Hält deine Domain aktuell
  duckdns:
    image: linuxserver/duckdns
    container_name: duckdns
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - TOKEN= 7c1b8270-16e4-40aa-a5f0-0b280a0bbd7d # <--- DEIN TOKEN HIER EINTRAGEN!
      - SUBDOMAINS=hybridcloudpotatoserver           # <--- DEIN DOMAINNAME (OHNE .duckdns.org)
      - LOGFILE=false
    networks:
      - Intern-netzwerk

  # 2. Caddy als Reverse Proxy (HTTPS-Manager)
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    # Diese Ports müssen im Router an deinen Server weitergeleitet werden!
    ports:
      - '80:80'   # HTTP / Let's Encrypt Challenge
      - '443:443' # HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - Intern-netzwerk

  # 3. Dein Webserver (Dashboard)
  webserver:
    image: 'php:8.2-apache'
    container_name: webserver
    restart: unless-stopped
    # KEINE PORTS MEHR! Zugriff nur über Caddy
    volumes:
      - /home/potato/WhaleFuerAbschluss/web:/var/www/html
      - ./apache-custom.conf:/etc/apache2/sites-available/000-default.conf
    user: "1000"
    networks:
      - Intern-netzwerk
      - Daten-netzwerk

  # 4. Nextcloud
  nextcloud:
    image: 'nextcloud:latest'
    container_name: nextcloud
    restart: unless-stopped
    # KEINE PORTS MEHR! Zugriff nur über Caddy
    volumes:
      - nextcloud-data:/var/www/html
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: Vollzeittrinker # ÄNDERN!
      # WICHTIG: Sag Nextcloud, dass es Caddy vertrauen soll
      TRUSTED_PROXIES: 'caddy'
      OVERWRITEPROTOCOL: 'https'
    depends_on:
      - db
    networks:
      - Intern-netzwerk
      - Daten-netzwerk

  # 5. Die Datenbank (für Nextcloud)
  db:
    image: 'mariadb:latest'
    # ... (Rest der Konfiguration)
    networks:
      - Daten-netzwerk

  # 6. Datenbankverwaltung (Adminer)
  adminer:
    image: 'adminer:latest'
    container_name: adminer
    restart: unless-stopped
    # KEINE PORTS MEHR! Zugriff nur über Caddy
    networks:
      - Daten-netzwerk
      - Intern-netzwerk

networks:
  Intern-netzwerk:
    driver: bridge
  Daten-netzwerk:
    driver: bridge

volumes:
  caddy-data:
  caddy-config:
  nextcloud-data:
  db-data: