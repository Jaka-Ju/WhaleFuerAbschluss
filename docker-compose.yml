services:
  
  # 2. Dein Webserver (wird das Dashboard)
  webserver:
    image: 'php:8.2-apache'
    container_name: webserver
    restart: unless-stopped
    # KEINE PORTS MEHR! Zugriff nur über Caddy
    volumes:
      - /home/potato/WhaleFuerAbschluss/web:/var/www/html
      - ./apache-custom.conf:/etc/apache2/sites-available/000-default.conf
    user: "1000"
    networks:
      - Intern-netzwerk
      - Daten-netzwerk

  # 4. Nextcloud
  nextcloud:
    image: 'nextcloud:latest'
    container_name: nextcloud
    restart: unless-stopped
    # KEINE PORTS MEHR! Zugriff nur über Caddy
    volumes:
      - nextcloud-data:/var/www/html
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: Vollzeittrinker # ÄNDERN!
      # WICHTIG: Sag Nextcloud, dass es Caddy vertrauen soll
      TRUSTED_PROXIES: 'caddy'
      OVERWRITEPROTOCOL: 'https'
    depends_on:
      - db
    networks:
      - Intern-netzwerk
      - Daten-netzwerk

  # 5. Die Datenbank (für Nextcloud)
  db:
    image: 'mariadb:latest'
    container_name: db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - db-data:/var/lib/mysql
    environment:
      #- MYSQL_ROOT_PASSWORD=Wurzelchef # ÄNDERN!
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=Vollzeittrinker # ÄNDERN!
    networks:
      - Daten-netzwerk

  # 6. Datenbankverwaltung (Adminer)
  adminer:
    image: 'adminer:latest'
    container_name: adminer
    restart: unless-stopped
    # KEINE PORTS MEHR! Zugriff nur über Caddy
    networks:
      - Daten-netzwerk
      - Intern-netzwerk

networks:
  Intern-netzwerk:
    driver: bridge
  Daten-netzwerk:
    driver: bridge

volumes:
  caddy-data:
  caddy-config:
  nextcloud-data:
  db-data: